import os
import streamlit as st
import pandas as pd
import joblib
import numpy as np

#Code generated by LLM - Streamlit app for TNR Incident Prediction

# Page configuration
st.set_page_config(
    page_title="TNR Incident Prediction",
    page_icon="üöÜ",
    layout="wide"
)

# Title and description
st.title("üöÜ TransNational Railways Incident Prediction System")
st.markdown("""
This application predicts the likelihood of railway incidents based on operational and environmental factors.
Enter the current conditions below to receive a real-time incident prediction.
""")

# Load the trained model and preprocessor
@st.cache_resource
def load_model_and_preprocessor():
    """Load the saved model and preprocessing pipeline"""
    try:
        # Get absolute path to project root (one level up from deployment folder)
        current_dir = os.path.dirname(os.path.abspath(__file__))
        project_root = os.path.dirname(current_dir)
        
        model_path = os.path.join(project_root, 'output', 'tuned_logistic_regression_model.pkl')
        preprocessor_path = os.path.join(project_root, 'output', 'preprocessor.pkl')
        
        model = joblib.load(model_path)
        preprocessor = joblib.load(preprocessor_path)
        return model, preprocessor
    except FileNotFoundError as e:
        st.error(f"Error loading model files: {e}")
        st.stop()

model, preprocessor = load_model_and_preprocessor()

st.markdown("---")

# Create input sections using columns and expanders
st.header("üìã Enter Current Conditions")

# Station Information
with st.expander("üöâ Station Information", expanded=True):
    col1, col2, col3 = st.columns(3)
    
    with col1:
        origin = st.selectbox(
            "Origin Station",
            options=['ABD', 'ALM', 'BDQ', 'BWK', 'DAR', 'DEE', 'DHM', 'DON', 'EDB', 
                    'GLC', 'GRA', 'HGT', 'HUL', 'INV', 'KGX', 'LCN', 'LDS', 'MBR', 
                    'NCL', 'NNG', 'PBO', 'PTH', 'RET', 'SKI', 'ST NEOTS', 'STG', 'SUN', 'YRK']
        )
    
    with col2:
        dest = st.selectbox(
            "Destination Station",
            options=['ABD', 'ALM', 'BDQ', 'BWK', 'DAR', 'DEE', 'DHM', 'DON', 'EDB', 
                    'GLC', 'GRA', 'HGT', 'HUL', 'HUNTINGDN', 'INV', 'KGX', 'LCN', 'LDS', 
                    'MBR', 'NCL', 'NNG', 'NTR', 'PBO', 'PTH', 'RET', 'SKI', 'ST NEOTS', 
                    'STG', 'SUN', 'YRK']
        )
    
    with col3:
        location = st.selectbox(
            "Current Location",
            options=['BWK', 'DAR', 'DHM', 'DON', 'EDB', 'GRA', 'KGX', 'LDS', 
                    'NCL', 'NNG', 'PBO', 'RET', 'WKF', 'YRK']
        )

# Time Information
with st.expander("üïê Time Information", expanded=True):
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        month = st.selectbox(
            "Month",
            options=['January', 'February', 'March', 'April', 'May', 'June', 
                    'July', 'August', 'September', 'October', 'November', 'December']
        )
    
    with col2:
        day = st.selectbox(
            "Day of Week",
            options=['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday']
        )
    
    with col3:
        location_hour = st.selectbox(
            "Current Hour (24h)",
            options=list(range(24))
        )
    
    with col4:
        dwell_time = st.number_input(
            "Dwell Time (minutes)",
            min_value=1.0,
            max_value=29.0,
            value=2.0,
            step=1.0,
            help="Time spent at the current station"
        )

    col5, col6, col7 = st.columns(3)
    
    with col5:
        location_part_of_day = st.selectbox(
            "Location Part of Day",
            options=['Early Morning', 'Morning', 'Noon', 'Evening', 'Night', 'Late Night']
        )
    
    with col6:
        origin_part_of_day = st.selectbox(
            "Origin Part of Day",
            options=['Early Morning', 'Morning', 'Noon', 'Evening', 'Night', 'Late Night']
        )
    
    with col7:
        dest_part_of_day = st.selectbox(
            "Destination Part of Day",
            options=['Early Morning', 'Morning', 'Noon', 'Evening', 'Night', 'Late Night']
        )

# Train Information
with st.expander("üöÑ Train Information", expanded=True):
    col1, col2 = st.columns(2)
    
    with col1:
        train_route_id = st.selectbox(
            "Train Route ID",
            options=['A', 'B', 'D', 'E', 'F', 'G', 'H', 'N', 'S', 'W', 'Y', 'Z']
        )
    
    with col2:
        train_service = st.selectbox(
            "Train Service Number",
            options=[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19,
                    20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37,
                    38, 39, 40, 41, 42, 43, 45, 46, 48, 49, 50, 51, 52, 55, 80, 81, 82, 83,
                    84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99]
        )
    
    st.info("‚ÑπÔ∏è Train Class: Azuma (constant for all services)")
    train_amplitude_record = st.number_input(
        "Train Amplitude Record",
        min_value=-0.81,
        max_value=0.86,
        value=0.0,
        step=0.01,
        format="%.4f",
        help="Operational amplitude measurement"
    )

# Booking Information
with st.expander("üìä Booking & Forecast Information", expanded=False):
    col1, col2 = st.columns(2)
    
    with col1:
        st.subheader("Current Bookings")
        on_train_bookings = st.number_input(
            "Passengers On Train (Booked)",
            min_value=0.0,
            max_value=902.0,
            value=20.0,
            step=1.0
        )
        off_train_bookings = st.number_input(
            "Passengers Off Train (Booked)",
            min_value=0.0,
            max_value=540.0,
            value=11.0,
            step=1.0
        )
    
    with col2:
        st.subheader("Forecasts")
        on_train_forecast = st.number_input(
            "Passengers On Train (Forecast)",
            min_value=0.0,
            max_value=902.0,
            value=27.93,
            step=1.0
        )
        off_train_forecast = st.number_input(
            "Passengers Off Train (Forecast)",
            min_value=0.0,
            max_value=540.0,
            value=17.87,
            step=1.0
        )

# Weather Information
with st.expander("‚òÅÔ∏è Weather Conditions", expanded=False):
    col1, col2, col3 = st.columns(3)
    
    with col1:
        weather_main = st.selectbox(
            "Weather Condition",
            options=['Clear', 'Clouds', 'Drizzle', 'Fog', 'Haze', 'Mist', 
                    'Rain', 'Snow', 'Thunderstorm', 'Tornado']
        )
        temp = st.number_input(
            "Temperature (¬∞C)",
            min_value=-7.0,
            max_value=35.0,
            value=13.26,
            step=0.1
        )
        feels_like = st.number_input(
            "Feels Like (¬∞C)",
            min_value=-12.0,
            max_value=37.0,
            value=12.62,
            step=0.1
        )
    
    with col2:
        temp_min = st.number_input(
            "Min Temperature (¬∞C)",
            min_value=-8.0,
            max_value=32.0,
            value=12.17,
            step=0.1
        )
        temp_max = st.number_input(
            "Max Temperature (¬∞C)",
            min_value=-7.0,
            max_value=35.0,
            value=14.08,
            step=0.1
        )
        pressure = st.number_input(
            "Pressure (hPa)",
            min_value=956.0,
            max_value=1044.0,
            value=1013.0,
            step=1.0
        )
    
    with col3:
        humidity = st.number_input(
            "Humidity (%)",
            min_value=1.0,
            max_value=100.0,
            value=80.0,
            step=1.0
        )
        wind_speed = st.number_input(
            "Wind Speed (m/s)",
            min_value=0.0,
            max_value=20.0,
            value=4.12,
            step=0.1
        )
        clouds_all = st.number_input(
            "Cloud Coverage (%)",
            min_value=0.0,
            max_value=100.0,
            value=75.0,
            step=1.0
        )

    col4, col5 = st.columns(2)
    
    with col4:
        rain_1h = st.number_input(
            "Rainfall (1h, mm)",
            min_value=0.0,
            max_value=50.0,
            value=0.0,
            step=0.1
        )
    
    with col5:
        snow_1h = st.number_input(
            "Snowfall (1h, mm)",
            min_value=0.0,
            max_value=3.0,
            value=0.0,
            step=0.1
        )

st.markdown("---")

# Prediction button
if st.button("üîÆ Predict Incident Risk", type="primary", use_container_width=True):
    
    # Calculate derived features
    # Location Time Interaction: Concatenate Location and Location Part Of Day
    location_time_interaction = f"{location} - {location_part_of_day}"
    
    # Rush Hour: Based on training logic - weekdays only, 7-10am or 4-7pm
    rush_hour = 1 if (
        day not in ['Saturday', 'Sunday'] and 
        ((7 <= location_hour <= 10) or (16 <= location_hour <= 19))
    ) else 0
    
    # Year set to 2024 (constant to match training data)
    year = 2024
    
    # Train Class is constant
    train_class = 'Azuma'
    
    # Create input dataframe with exact same column order as training
    input_data = pd.DataFrame({
        'Origin': [origin],
        'Dest': [dest],
        'Location': [location],
        'Dwell Time': [dwell_time],
        'On Train Bookings': [on_train_bookings],
        'On Train Forecast': [on_train_forecast],
        'Off Train Bookings': [off_train_bookings],
        'Off Train Forecast': [off_train_forecast],
        'Temp': [temp],
        'Feels Like': [feels_like],
        'Temp Min': [temp_min],
        'Temp Max': [temp_max],
        'Pressure': [pressure],
        'Humidity': [humidity],
        'Wind Speed': [wind_speed],
        'Rain 1H': [rain_1h],
        'Snow 1H': [snow_1h],
        'Clouds All': [clouds_all],
        'Weather Main': [weather_main],
        'Year': [year],
        'Month': [month],
        'Day': [day],
        'Location Hour': [location_hour],
        'Location Part Of Day': [location_part_of_day],
        'Origin Part Of Day': [origin_part_of_day],
        'Dest Part Of Day': [dest_part_of_day],
        'Train Route Id': [train_route_id],
        'Train Service': [train_service],
        'Train Class': [train_class],
        'Train Amplitude Record': [train_amplitude_record],
        'Location Time Interaction': [location_time_interaction],
        'Rush Hour': [rush_hour]
    })
    
    # Apply preprocessing
    input_processed = preprocessor.transform(input_data)
    
    # Make prediction
    prediction = model.predict(input_processed)[0]
    prediction_proba = model.predict_proba(input_processed)[0]
    
    # Display results
    st.markdown("---")
    st.header("üìä Prediction Results")
    
    # Create columns for result display
    col1, col2, col3 = st.columns([1, 2, 1])
    
    with col2:
        if prediction == 1:
            st.error("‚ö†Ô∏è INCIDENT PREDICTED")
            st.markdown(f"""
            <div style='text-align: center; padding: 20px; background-color: #ff4444; border-radius: 10px;'>
                <h2 style='color: white; margin: 0;'>HIGH RISK</h2>
                <p style='color: white; font-size: 18px; margin: 10px 0 0 0;'>
                    Incident Probability: {prediction_proba[1]:.1%}
                </p>
            </div>
            """, unsafe_allow_html=True)
            st.warning("**Recommendation:** Alert operational staff and prepare contingency measures.")
        else:
            st.success("‚úÖ NO INCIDENT PREDICTED")
            st.markdown(f"""
            <div style='text-align: center; padding: 20px; background-color: #44ff44; border-radius: 10px;'>
                <h2 style='color: #004400; margin: 0;'>LOW RISK</h2>
                <p style='color: #004400; font-size: 18px; margin: 10px 0 0 0;'>
                    Incident Probability: {prediction_proba[1]:.1%}
                </p>
            </div>
            """, unsafe_allow_html=True)
            st.info("**Recommendation:** Continue normal operations with standard monitoring.")
    
    # Show probability breakdown
    st.markdown("### Probability Breakdown")
    col1, col2 = st.columns(2)
    
    with col1:
        st.metric(
            label="No Incident Probability",
            value=f"{prediction_proba[0]:.1%}",
            delta=None
        )
    
    with col2:
        st.metric(
            label="Incident Probability",
            value=f"{prediction_proba[1]:.1%}",
            delta=None
        )
    
    # Show derived features for transparency
    with st.expander("üîç Calculated Features"):
        st.write(f"**Location Time Interaction:** {location_time_interaction}")
        st.write(f"**Rush Hour:** {'Yes' if rush_hour == 1 else 'No'}")
        st.write(f"**Year (constant):** {year}")
        st.write(f"**Train Class (constant):** {train_class}")

# Footer
st.markdown("---")
st.markdown("""
<div style='text-align: center; color: #666; padding: 20px;'>
    <p>TransNational Railways Incident Prediction System | Machine Learning in Practice</p>
    <p>Model: Tuned Logistic Regression | Optimised for Recall</p>
</div>
""", unsafe_allow_html=True)